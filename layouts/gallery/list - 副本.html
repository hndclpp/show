{{ define "main" }}
<div class="gallery-container">
    <div class="masonry-grid">
        {{ range .Params.images }}
        <div class="masonry-item">
            <a href="{{ .url }}" target="_blank" rel="noopener noreferrer" aria-label="View {{ .title }}">
                <img src="{{ .url }}" alt="{{ .title }}" loading="lazy" class="lazy-img">
                <div class="masonry-title">{{ .title }}</div>
            </a>
        </div>
        {{ end }}
    </div>
</div>

<style>
/* 容器样式 */
.gallery-container {
    padding: 20px;
    text-align: center;
}

/* 瀑布流网格 */
.masonry-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
}

/* 单个图片项 */
.masonry-item {
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: flex-end;
    border-radius: 8px;
    transition: transform 0.3s, box-shadow 0.3s;
}

.masonry-item img {
    width: 100%;
    height: auto;
    display: block;
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    border-radius: 8px;
    background-color: #eaeaea; /* 加载失败时的回退背景色 */
}

.masonry-item img.loaded {
    opacity: 1;
}

.masonry-item img.loading-failed {
    content: url('fallback-image.jpg');
}

.masonry-title {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(0, 0, 0, 0.6);
    color: #fff;
    padding: 8px;
    font-size: 0.8rem;
    text-align: center;
    opacity: 0;
    visibility: hidden;
    transform: translateY(5px);
    transition: opacity 0.3s, transform 0.3s;
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
}

.masonry-item:hover .masonry-title {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.masonry-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

/* 响应式设计 */
@media (max-width: 768px) {
    .masonry-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
}

@media (max-width: 480px) {
    .masonry-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const grid = document.querySelector(".masonry-grid");
    const items = Array.from(document.querySelectorAll(".masonry-item"));

    // 动态调整网格项高度
    const resizeGridItem = (item) => {
        const img = item.querySelector("img");
        const gridRowHeight = parseInt(window.getComputedStyle(grid).getPropertyValue("grid-auto-rows")) || 10;
        const rowGap = parseInt(window.getComputedStyle(grid).getPropertyValue("gap")) || 16;

        if (img.complete) {
            const rowSpan = Math.ceil((img.offsetHeight + rowGap) / (gridRowHeight + rowGap));
            item.style.gridRowEnd = `span ${rowSpan}`;
        }
    };

    // 图片加载完成后的处理
    const handleImageLoad = (img, item) => {
        img.classList.add("loaded");
        resizeGridItem(item);
    };

    // 图片加载失败处理
    const handleImageError = (img) => {
        img.classList.add("loading-failed");
    };

    // 初始化瀑布流布局
    const initMasonryGrid = () => {
        items.forEach((item) => {
            const img = item.querySelector("img");
            if (img.complete) {
                handleImageLoad(img, item);
            } else {
                img.onload = () => handleImageLoad(img, item);
                img.onerror = () => handleImageError(img);
            }
        });
    };

    // 监听网格变化
    const observer = new ResizeObserver(() => {
        items.forEach(resizeGridItem);
    });

    observer.observe(grid);

    initMasonryGrid();
});
</script>
{{ end }}
